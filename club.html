<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Club Leden - RealDutch Minis</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eaeaea;
        }
        
        h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-box {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            flex: 1;
            min-width: 180px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .stat-box:hover {
            transform: translateY(-5px);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .search-box {
            position: relative;
            flex: 1;
            min-width: 300px;
        }
        
        #searchInput {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #ddd;
            border-radius: 30px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        #searchInput:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }
        
        .filter-box {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        #roleFilter {
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 30px;
            font-size: 16px;
            background-color: white;
            cursor: pointer;
        }
        
        .link-mini-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .link-mini-section h2 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.4rem;
        }
        
        .link-form {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        
        .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }
        
        .btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            overflow: hidden;
        }
        
        thead {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
        }
        
        th {
            padding: 16px 15px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            position: relative;
            user-select: none;
            transition: background 0.3s;
        }
        
        th:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        th::after {
            content: "↕";
            position: absolute;
            right: 10px;
            opacity: 0.7;
        }
        
        th.sorted-asc::after {
            content: "↑";
        }
        
        th.sorted-desc::after {
            content: "↓";
        }
        
        tbody tr {
            border-bottom: 1px solid #eaeaea;
            transition: background 0.3s;
        }
        
        tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        td {
            padding: 14px 15px;
        }
        
        .role-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: capitalize;
        }
        
        .role-president {
            background-color: #e74c3c;
            color: white;
        }
        
        .role-vicePresident {
            background-color: #f39c12;
            color: white;
        }
        
        .role-senior {
            background-color: #9b59b6;
            color: white;
        }
        
        .role-member {
            background-color: #3498db;
            color: white;
        }
        
        .trophies-cell {
            font-weight: 600;
            text-align: right;
        }
        
        .linked-account {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .linked-account-name {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .linked-account-tag {
            font-size: 0.85rem;
            color: #7f8c8d;
        }
        
        .unlink-btn {
            background: none;
            border: none;
            color: #e74c3c;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0 5px;
            transition: all 0.3s;
        }
        
        .unlink-btn:hover {
            transform: scale(1.2);
        }
        
        .copy-section {
            background-color: #e8f4fc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .copy-section h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .copy-textarea {
            width: 100%;
            height: 120px;
            padding: 15px;
            border: 2px solid #3498db;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            resize: vertical;
            margin-bottom: 10px;
            background-color: #f8f9fa;
        }
        
        .copy-buttons {
            display: flex;
            gap: 10px;
        }
        
        .links-list {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .links-list h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .links-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .links-table th {
            background: linear-gradient(135deg, #3498db, #2980b9);
            padding: 12px 15px;
            text-align: left;
        }
        
        .links-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .export-import-section {
            background-color: #f0f7ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .export-import-section h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .export-import-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #7f8c8d;
        }
        
        .error {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #e74c3c;
            background-color: #fadbd8;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .success {
            text-align: center;
            padding: 15px;
            font-size: 1rem;
            color: #27ae60;
            background-color: #d5f4e6;
            border-radius: 10px;
            margin: 10px 0;
            display: none;
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eaeaea;
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .stats {
                flex-direction: column;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                min-width: 100%;
            }
            
            .link-form {
                flex-direction: column;
                align-items: stretch;
            }
            
            .form-group {
                min-width: 100%;
            }
            
            .action-buttons, .copy-buttons, .export-import-buttons {
                flex-direction: column;
            }
            
            th, td {
                padding: 10px 8px;
            }
            
            table {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Club Leden - RealDutch Minis</h1>
            <p class="subtitle">Overzicht van minis en hun hoofdaccounts</p>
        </header>
        
        <div class="tabs">
            <button class="tab active" data-tab="overview">Overzicht</button>
            <button class="tab" data-tab="links">Koppelingen Beheer</button>
            <button class="tab" data-tab="export">Export/Import</button>
        </div>
        
        <!-- Overzicht Tab -->
        <div class="tab-content active" id="overview">
            <div class="stats">
                <div class="stat-box">
                    <div class="stat-value" id="totalMembers">-</div>
                    <div class="stat-label">Totaal Leden</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="avgTrophies">-</div>
                    <div class="stat-label">Gemiddelde Trophies</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="totalTrophies">-</div>
                    <div class="stat-label">Totaal Trophies</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="highestTrophies">-</div>
                    <div class="stat-label">Hoogste Trophies</div>
                </div>
            </div>
            
            <div class="link-mini-section">
                <h2>Koppel een mini aan een hoofdaccount</h2>
                <div class="success" id="successMessage"></div>
                <form class="link-form" id="linkForm">
                    <div class="form-group">
                        <label for="miniSelect">Selecteer Mini:</label>
                        <select id="miniSelect" required>
                            <option value="">Kies een mini...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="mainAccountTag">Hoofdaccount Tag (zonder #):</label>
                        <input type="text" id="mainAccountTag" placeholder="Bijv: ABC123" required>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn">Koppelen</button>
                    </div>
                </form>
            </div>
            
            <div class="controls">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Zoek op naam of tag...">
                </div>
                <div class="filter-box">
                    <label for="roleFilter">Filter op rol:</label>
                    <select id="roleFilter">
                        <option value="all">Alle rollen</option>
                        <option value="president">President</option>
                        <option value="vicePresident">Vice President</option>
                        <option value="senior">Senior</option>
                        <option value="member">Lid</option>
                    </select>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-info" id="copyDiscordBtn">Kopieer voor Discord</button>
                <button class="btn btn-secondary" id="clearLinksBtn">Alle koppelingen verwijderen</button>
            </div>
            
            <div id="tableContainer">
                <div class="loading" id="loadingMessage">Leden aan het laden...</div>
                <div class="error" id="errorMessage" style="display: none;"></div>
                <table id="membersTable" style="display: none;">
                    <thead>
                        <tr>
                            <th data-sort="name">Mini Naam</th>
                            <th data-sort="tag">Mini Tag</th>
                            <th data-sort="role">Rol</th>
                            <th data-sort="trophies">Trophies</th>
                            <th data-sort="mainAccount">Hoofdaccount</th>
                            <th>Acties</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Data wordt hier ingevoegd via JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Koppelingen Beheer Tab -->
        <div class="tab-content" id="links">
            <div class="links-list">
                <h3>Alle Koppelingen</h3>
                <table class="links-table">
                    <thead>
                        <tr>
                            <th>Mini Naam</th>
                            <th>Mini Tag</th>
                            <th>Hoofdaccount Naam</th>
                            <th>Hoofdaccount Tag</th>
                            <th>Acties</th>
                        </tr>
                    </thead>
                    <tbody id="linksTableBody">
                        <!-- Koppelingen worden hier ingevoegd -->
                    </tbody>
                </table>
                <div id="noLinksMessage" style="text-align: center; padding: 20px; color: #7f8c8d; display: none;">
                    Geen koppelingen gevonden
                </div>
            </div>
            
            <div class="copy-section">
                <h3>Kopieer koppelingen voor Discord</h3>
                <textarea class="copy-textarea" id="discordLinksText" readonly placeholder="Koppelingen worden hier weergegeven..."></textarea>
                <div class="copy-buttons">
                    <button class="btn btn-info" id="copyLinksBtn">Kopieer naar klembord</button>
                    <button class="btn btn-secondary" id="refreshLinksBtn">Vernieuw lijst</button>
                </div>
            </div>
        </div>
        
        <!-- Export/Import Tab -->
        <div class="tab-content" id="export">
            <div class="export-import-section">
                <h3>Exporteer Koppelingen</h3>
                <p>Exporteer alle koppelingen naar een bestand voor back-up.</p>
                <div class="export-import-buttons">
                    <button class="btn btn-info" id="exportJsonBtn">Exporteer als JSON</button>
                    <button class="btn btn-info" id="exportTxtBtn">Exporteer als Tekst</button>
                </div>
            </div>
            
            <div class="export-import-section">
                <h3>Importeer Koppelingen</h3>
                <p>Importeer koppelingen vanuit een eerder geëxporteerd bestand.</p>
                <div class="export-import-buttons">
                    <input type="file" id="importFile" accept=".json,.txt" style="display: none;">
                    <button class="btn btn-warning" id="importBtn">Importeer Bestand</button>
                    <button class="btn btn-secondary" id="resetDataBtn">Reset Alle Data</button>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Gemaakt door Remy :)</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tableBody = document.getElementById('tableBody');
            const loadingMessage = document.getElementById('loadingMessage');
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');
            const membersTable = document.getElementById('membersTable');
            const searchInput = document.getElementById('searchInput');
            const roleFilter = document.getElementById('roleFilter');
            const miniSelect = document.getElementById('miniSelect');
            const mainAccountTag = document.getElementById('mainAccountTag');
            const linkForm = document.getElementById('linkForm');
            const clearLinksBtn = document.getElementById('clearLinksBtn');
            const copyDiscordBtn = document.getElementById('copyDiscordBtn');
            const totalMembersEl = document.getElementById('totalMembers');
            const avgTrophiesEl = document.getElementById('avgTrophies');
            const totalTrophiesEl = document.getElementById('totalTrophies');
            const highestTrophiesEl = document.getElementById('highestTrophies');
            const linksTableBody = document.getElementById('linksTableBody');
            const noLinksMessage = document.getElementById('noLinksMessage');
            const discordLinksText = document.getElementById('discordLinksText');
            const copyLinksBtn = document.getElementById('copyLinksBtn');
            const refreshLinksBtn = document.getElementById('refreshLinksBtn');
            const exportJsonBtn = document.getElementById('exportJsonBtn');
            const exportTxtBtn = document.getElementById('exportTxtBtn');
            const importBtn = document.getElementById('importBtn');
            const importFile = document.getElementById('importFile');
            const resetDataBtn = document.getElementById('resetDataBtn');
            
            // Tab functionaliteit
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    // Update active tab
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Update active content
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === tabId) {
                            content.classList.add('active');
                        }
                    });
                    
                    // Als de links tab actief wordt, update de lijst
                    if (tabId === 'links') {
                        updateLinksTable();
                        updateDiscordLinksText();
                    }
                });
            });
            
            let membersData = [];
            let filteredData = [];
            let sortColumn = 'trophies';
            let sortDirection = 'desc';
            let linkedAccounts = JSON.parse(localStorage.getItem('realDutchMinisLinkedAccounts')) || {};
            
            // Laad de club data
            fetchClubData();
            
            // Event listeners voor zoeken en filteren
            searchInput.addEventListener('input', filterMembers);
            roleFilter.addEventListener('change', filterMembers);
            
            // Event listeners voor sorteren
            document.querySelectorAll('th[data-sort]').forEach(header => {
                header.addEventListener('click', () => {
                    const column = header.getAttribute('data-sort');
                    
                    if (sortColumn === column) {
                        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortColumn = column;
                        sortDirection = 'desc';
                    }
                    
                    // Update UI voor sortering
                    document.querySelectorAll('th').forEach(th => {
                        th.classList.remove('sorted-asc', 'sorted-desc');
                    });
                    header.classList.add(sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
                    
                    sortMembers();
                    renderTable();
                });
            });
            
            // Event listener voor formulier
            linkForm.addEventListener('submit', function(e) {
                e.preventDefault();
                linkMiniToMainAccount();
            });
            
            // Event listener voor verwijderen alle koppelingen
            clearLinksBtn.addEventListener('click', function() {
                if (confirm('Weet je zeker dat je alle koppelingen wilt verwijderen?')) {
                    linkedAccounts = {};
                    localStorage.setItem('realDutchMinisLinkedAccounts', JSON.stringify(linkedAccounts));
                    showSuccess('Alle koppelingen zijn verwijderd');
                    renderTable();
                    updateMiniSelect();
                    updateLinksTable();
                    updateDiscordLinksText();
                }
            });
            
            // Event listener voor kopiëren Discord
            copyDiscordBtn.addEventListener('click', function() {
                updateDiscordLinksText();
                discordLinksText.select();
                document.execCommand('copy');
                showSuccess('Ledenlijst gekopieerd naar klembord!');
            });
            
            // Event listeners voor koppelingen tab
            copyLinksBtn.addEventListener('click', function() {
                discordLinksText.select();
                document.execCommand('copy');
                showSuccess('Koppelingen gekopieerd naar klembord!');
            });
            
            refreshLinksBtn.addEventListener('click', function() {
                updateLinksTable();
                updateDiscordLinksText();
                showSuccess('Lijst vernieuwd!');
            });
            
            // Event listeners voor export/import
            exportJsonBtn.addEventListener('click', function() {
                exportData('json');
            });
            
            exportTxtBtn.addEventListener('click', function() {
                exportData('txt');
            });
            
            importBtn.addEventListener('click', function() {
                importFile.click();
            });
            
            importFile.addEventListener('change', function(e) {
                importData(e.target.files[0]);
            });
            
            resetDataBtn.addEventListener('click', function() {
                if (confirm('Weet je zeker dat je alle koppelingen wilt resetten? Dit kan niet ongedaan worden gemaakt.')) {
                    linkedAccounts = {};
                    localStorage.setItem('realDutchMinisLinkedAccounts', JSON.stringify(linkedAccounts));
                    showSuccess('Alle koppelingen zijn gereset');
                    renderTable();
                    updateMiniSelect();
                    updateLinksTable();
                    updateDiscordLinksText();
                }
            });
            
            // Functie om club data op te halen met CORS proxy
            async function fetchClubData() {
                try {
                    // Gebruik een CORS proxy om CORS errors te omzeilen
                    const proxyUrl = 'https://api.allorigins.win/raw?url=';
                    const targetUrl = 'https://badrandoms.com/api/club?tag=%232RY829PPO';
                    const apiUrl = proxyUrl + encodeURIComponent(targetUrl);
                    
                    const response = await fetch(apiUrl);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data && data.items) {
                        membersData = data.items;
                        filteredData = [...membersData];
                        updateStats();
                        sortMembers();
                        renderTable();
                        updateMiniSelect();
                        
                        // Verberg laadbericht en toon tabel
                        loadingMessage.style.display = 'none';
                        membersTable.style.display = 'table';
                    } else {
                        throw new Error('Ongeldige data ontvangen van de API');
                    }
                } catch (error) {
                    console.error('Fout bij ophalen van data:', error);
                    loadingMessage.style.display = 'none';
                    errorMessage.textContent = `Fout bij laden van data: ${error.message}`;
                    errorMessage.style.display = 'block';
                    
                    // Fallback: probeer directe fetch zonder proxy
                    tryDirectFetch();
                }
            }
            
            // Fallback functie voor directe fetch
            async function tryDirectFetch() {
                try {
                    console.log('Probeer directe fetch...');
                    const response = await fetch('https://badrandoms.com/api/club?tag=%232RY829PPO', {
                        mode: 'cors',
                        headers: {
                            'Accept': 'application/json',
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data && data.items) {
                            membersData = data.items;
                            filteredData = [...membersData];
                            updateStats();
                            sortMembers();
                            renderTable();
                            updateMiniSelect();
                            
                            loadingMessage.style.display = 'none';
                            membersTable.style.display = 'table';
                            errorMessage.style.display = 'none';
                        }
                    }
                } catch (directError) {
                    console.error('Ook directe fetch mislukt:', directError);
                }
            }
            
            // Functie om mini te koppelen aan hoofdaccount
            async function linkMiniToMainAccount() {
                const miniTag = miniSelect.value;
                const mainTag = mainAccountTag.value.trim();
                
                if (!miniTag || !mainTag) {
                    alert('Vul alle velden in');
                    return;
                }
                
                try {
                    // Haal gegevens van hoofdaccount op
                    const proxyUrl = 'https://api.allorigins.win/raw?url=';
                    const targetUrl = `https://badrandoms.com/api/player?tag=%23${mainTag}`;
                    const apiUrl = proxyUrl + encodeURIComponent(targetUrl);
                    
                    const response = await fetch(apiUrl);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data && data.name) {
                        // Sla koppeling op
                        linkedAccounts[miniTag] = {
                            tag: mainTag,
                            name: data.name
                        };
                        
                        localStorage.setItem('realDutchMinisLinkedAccounts', JSON.stringify(linkedAccounts));
                        
                        // Toon succesbericht
                        const miniName = membersData.find(member => member.tag === miniTag)?.name || miniTag;
                        showSuccess(`Mini "${miniName}" is gekoppeld aan hoofdaccount "${data.name}"`);
                        
                        // Reset formulier
                        linkForm.reset();
                        
                        // Update tabel
                        renderTable();
                        updateMiniSelect();
                        updateLinksTable();
                        updateDiscordLinksText();
                    } else {
                        throw new Error('Kon hoofdaccount niet vinden');
                    }
                } catch (error) {
                    console.error('Fout bij koppelen:', error);
                    alert(`Fout bij koppelen: ${error.message}`);
                }
            }
            
            // Functie om koppeling te verwijderen
            function unlinkMini(miniTag) {
                if (confirm('Weet je zeker dat je deze koppeling wilt verwijderen?')) {
                    delete linkedAccounts[miniTag];
                    localStorage.setItem('realDutchMinisLinkedAccounts', JSON.stringify(linkedAccounts));
                    showSuccess('Koppeling verwijderd');
                    renderTable();
                    updateMiniSelect();
                    updateLinksTable();
                    updateDiscordLinksText();
                }
            }
            
            // Functie om leden te filteren
            function filterMembers() {
                const searchTerm = searchInput.value.toLowerCase();
                const roleValue = roleFilter.value;
                
                filteredData = membersData.filter(member => {
                    const matchesSearch = member.name.toLowerCase().includes(searchTerm) || 
                                         member.tag.toLowerCase().includes(searchTerm);
                    const matchesRole = roleValue === 'all' || member.role === roleValue;
                    
                    return matchesSearch && matchesRole;
                });
                
                updateStats();
                sortMembers();
                renderTable();
            }
            
            // Functie om leden te sorteren
            function sortMembers() {
                filteredData.sort((a, b) => {
                    let aValue, bValue;
                    
                    if (sortColumn === 'trophies') {
                        aValue = a.trophies;
                        bValue = b.trophies;
                    } else if (sortColumn === 'mainAccount') {
                        // Sorteren op hoofdaccount naam
                        const aMainAccount = linkedAccounts[a.tag];
                        const bMainAccount = linkedAccounts[b.tag];
                        
                        aValue = aMainAccount ? aMainAccount.name.toLowerCase() : '';
                        bValue = bMainAccount ? bMainAccount.name.toLowerCase() : '';
                    } else {
                        aValue = a[sortColumn].toLowerCase();
                        bValue = b[sortColumn].toLowerCase();
                    }
                    
                    if (aValue < bValue) return sortDirection === 'asc' ? -1 : 1;
                    if (aValue > bValue) return sortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
            }
            
            // Functie om de tabel te renderen
            function renderTable() {
                tableBody.innerHTML = '';
                
                if (filteredData.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="6" style="text-align: center; padding: 30px; color: #7f8c8d;">Geen leden gevonden met de huidige filters</td>`;
                    tableBody.appendChild(row);
                    return;
                }
                
                filteredData.forEach(member => {
                    const row = document.createElement('tr');
                    
                    // Formatteer de rol
                    let roleText = member.role;
                    if (member.role === 'vicePresident') {
                        roleText = 'Vice President';
                    }
                    
                    // Haal gekoppeld hoofdaccount op
                    const mainAccount = linkedAccounts[member.tag];
                    
                    row.innerHTML = `
                        <td>${escapeHtml(member.name)}</td>
                        <td>${escapeHtml(member.tag)}</td>
                        <td><span class="role-badge role-${member.role}">${roleText}</span></td>
                        <td class="trophies-cell">${member.trophies.toLocaleString()}</td>
                        <td>
                            ${mainAccount ? 
                                `<div class="linked-account">
                                    <span class="linked-account-name">${escapeHtml(mainAccount.name)}</span>
                                    <span class="linked-account-tag">#${escapeHtml(mainAccount.tag)}</span>
                                </div>` : 
                                '<span style="color: #95a5a6; font-style: italic;">Niet gekoppeld</span>'
                            }
                        </td>
                        <td>
                            ${mainAccount ? 
                                `<button class="unlink-btn" data-tag="${member.tag}" title="Koppeling verwijderen">✕</button>` : 
                                ''
                            }
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // Voeg event listeners toe aan unlink knoppen
                document.querySelectorAll('.unlink-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const miniTag = this.getAttribute('data-tag');
                        unlinkMini(miniTag);
                    });
                });
            }
            
            // Functie om statistieken bij te werken
            function updateStats() {
                const totalMembers = filteredData.length;
                const totalTrophies = filteredData.reduce((sum, member) => sum + member.trophies, 0);
                const avgTrophies = totalMembers > 0 ? Math.round(totalTrophies / totalMembers) : 0;
                const highestTrophies = filteredData.length > 0 ? 
                    Math.max(...filteredData.map(member => member.trophies)) : 0;
                
                totalMembersEl.textContent = totalMembers.toLocaleString();
                avgTrophiesEl.textContent = avgTrophies.toLocaleString();
                totalTrophiesEl.textContent = totalTrophies.toLocaleString();
                highestTrophiesEl.textContent = highestTrophies.toLocaleString();
            }
            
            // Functie om mini select dropdown bij te werken
            function updateMiniSelect() {
                miniSelect.innerHTML = '<option value="">Kies een mini...</option>';
                
                membersData.forEach(member => {
                    // Toon alleen minis die nog niet gekoppeld zijn
                    if (!linkedAccounts[member.tag]) {
                        const option = document.createElement('option');
                        option.value = member.tag;
                        option.textContent = `${member.name} (${member.tag})`;
                        miniSelect.appendChild(option);
                    }
                });
            }
            
            // Functie om koppelingen tabel bij te werken
            function updateLinksTable() {
                linksTableBody.innerHTML = '';
                
                const linkedEntries = Object.entries(linkedAccounts);
                
                if (linkedEntries.length === 0) {
                    noLinksMessage.style.display = 'block';
                    return;
                }
                
                noLinksMessage.style.display = 'none';
                
                linkedEntries.forEach(([miniTag, mainAccount]) => {
                    const mini = membersData.find(m => m.tag === miniTag);
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${mini ? escapeHtml(mini.name) : 'Onbekend'}</td>
                        <td>${escapeHtml(miniTag)}</td>
                        <td>${escapeHtml(mainAccount.name)}</td>
                        <td>#${escapeHtml(mainAccount.tag)}</td>
                        <td>
                            <button class="unlink-btn" data-tag="${miniTag}" title="Koppeling verwijderen">✕</button>
                        </td>
                    `;
                    
                    linksTableBody.appendChild(row);
                });
                
                // Voeg event listeners toe aan unlink knoppen
                document.querySelectorAll('#linksTableBody .unlink-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const miniTag = this.getAttribute('data-tag');
                        unlinkMini(miniTag);
                    });
                });
            }
            
            // Functie om Discord tekst bij te werken
            function updateDiscordLinksText() {
                let text = "**RealDutch Minis - Koppelingen**\n\n";
                
                const linkedEntries = Object.entries(linkedAccounts);
                
                if (linkedEntries.length === 0) {
                    text += "Geen koppelingen gevonden.";
                } else {
                    linkedEntries.forEach(([miniTag, mainAccount]) => {
                        const mini = membersData.find(m => m.tag === miniTag);
                        if (mini) {
                            text += `- ${mini.name} (${mini.tag}) → ${mainAccount.name} (#${mainAccount.tag})\n`;
                        }
                    });
                }
                
                discordLinksText.value = text;
            }
            
            // Functie om data te exporteren
            function exportData(format) {
                const data = {
                    linkedAccounts: linkedAccounts,
                    exportDate: new Date().toISOString(),
                    clubTag: "#2RY829PPO"
                };
                
                let content, filename, mimeType;
                
                if (format === 'json') {
                    content = JSON.stringify(data, null, 2);
                    filename = `realdutch-minis-koppelingen-${new Date().toISOString().split('T')[0]}.json`;
                    mimeType = 'application/json';
                } else {
                    content = "RealDutch Minis Koppelingen\n";
                    content += "Export datum: " + new Date().toLocaleDateString('nl-NL') + "\n\n";
                    
                    Object.entries(linkedAccounts).forEach(([miniTag, mainAccount]) => {
                        const mini = membersData.find(m => m.tag === miniTag);
                        content += `${mini ? mini.name : 'Onbekend'} (${miniTag}) -> ${mainAccount.name} (#${mainAccount.tag})\n`;
                    });
                    
                    filename = `realdutch-minis-koppelingen-${new Date().toISOString().split('T')[0]}.txt`;
                    mimeType = 'text/plain';
                }
                
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showSuccess(`Koppelingen geëxporteerd als ${format.toUpperCase()} bestand!`);
            }
            
            // Functie om data te importeren
            function importData(file) {
                if (!file) return;
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        let importedData;
                        
                        if (file.name.endsWith('.json')) {
                            importedData = JSON.parse(content);
                            
                            if (importedData.linkedAccounts) {
                                linkedAccounts = importedData.linkedAccounts;
                                localStorage.setItem('realDutchMinisLinkedAccounts', JSON.stringify(linkedAccounts));
                                showSuccess('Koppelingen geïmporteerd vanuit JSON bestand!');
                            } else {
                                throw new Error('Ongeldig JSON bestand');
                            }
                        } else {
                            // Probeer tekstbestand te parsen
                            const lines = content.split('\n');
                            const newLinkedAccounts = {};
                            
                            lines.forEach(line => {
                                // Zoek naar patroon: naam (tag) -> naam (#tag)
                                const match = line.match(/(.+) \(([^)]+)\) -> (.+) \(#([^)]+)\)/);
                                if (match) {
                                    const [, , miniTag, , mainTag] = match;
                                    newLinkedAccounts[miniTag] = {
                                        tag: mainTag,
                                        name: match[3] // Hoofdaccount naam
                                    };
                                }
                            });
                            
                            if (Object.keys(newLinkedAccounts).length > 0) {
                                linkedAccounts = newLinkedAccounts;
                                localStorage.setItem('realDutchMinisLinkedAccounts', JSON.stringify(linkedAccounts));
                                showSuccess('Koppelingen geïmporteerd vanuit tekstbestand!');
                            } else {
                                throw new Error('Geen geldige koppelingen gevonden in het bestand');
                            }
                        }
                        
                        // Update alle weergaven
                        renderTable();
                        updateMiniSelect();
                        updateLinksTable();
                        updateDiscordLinksText();
                        
                    } catch (error) {
                        alert(`Fout bij importeren: ${error.message}`);
                    }
                };
                
                reader.readAsText(file);
                importFile.value = ''; // Reset file input
            }
            
            // Functie om succesbericht te tonen
            function showSuccess(message) {
                successMessage.textContent = message;
                successMessage.style.display = 'block';
                
                setTimeout(() => {
                    successMessage.style.display = 'none';
                }, 5000);
            }
            
            // Hulp functie om HTML te escapen
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        });
    </script>
</body>
</html>
